substitutions:
  name: default
  dname: ${name}-clock
  uname: ${name}_clock

esphome:
  platformio_options:
    board_build.flash_size: 8MB
    board_upload.maximum_size: 8388608
  name: $dname
  includes: 
    # download from https://github.com/adafruit/Adafruit_LED_Backpack
    - include/Adafruit_LEDBackpack.h
  libraries:
    - "Wire"
    - "SPI"
    - "Adafruit BusIO"
    - "Adafruit GFX Library"
    - "Adafruit LED Backpack Library"

esp32:
  board: adafruit_feather_esp32s3
  flash_size: 8MB
  framework:
    type: arduino

# Enable logging
logger:
  logs:
    component: ERROR

ota:
  platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_ssid_password

bluetooth_proxy:

api:

# the ESP32 board used has i2c on non-standard pins
i2c:
  sda: 3
  scl: 4

time:
  - platform: homeassistant
    id: homeassistant_time
    on_time:
      - seconds: 0
        minutes: /1 # Update every minute
        then:
          - script.execute: time_update    

script:
  - id: time_update
    then:
      - lambda: |-
          static Adafruit_7segment clock = Adafruit_7segment();
          int hours = id(homeassistant_time).now().hour;
          int minutes = id(homeassistant_time).now().minute;
          int displayValue = hours*100 + minutes;
          clock.begin(0x70);
          clock.print(displayValue, DEC);
          clock.drawColon(1);
          clock.writeDisplay();

# setup sensors
button:
  - platform: restart
    name: ${uname} restart
  - platform: safe_mode
    name: ${uname} restart safe
    icon: mdi:restart-alert

binary_sensor:
  - platform: status
    name: ${uname} status

sensor:
  - platform: wifi_signal
    name:  ${uname} wifi signal
    update_interval: 60s
  - platform: uptime
    id: uptime_seconds
    internal: true

text_sensor:
  - platform: template
    name: ${uname} uptime
    entity_category: diagnostic
    lambda: |-
      char s[20];
      char s_days[5];
      char s_hours[2];
      char s_seconds[2];
      char s_minutes[2];
      int seconds = (id(uptime_seconds).state);
      int days = seconds / (24 * 3600);
      seconds = seconds % (24 * 3600);
      int hours = seconds / 3600;
      seconds = seconds % 3600;
      int minutes = seconds /  60;
      seconds = seconds % 60;
      itoa(days, s_days, 10);
      itoa(hours, s_hours, 10);
      itoa(minutes, s_minutes, 10);
      itoa(seconds, s_seconds, 10);
      if ( days > 3650 ) {
        return { "Starting up" };
      } else if ( days ) {
        strcpy(s, s_days);
        strcat(s, "d ");
        strcat(s, s_hours);
        strcat(s, "h ");
        strcat(s, s_minutes);
        strcat(s, "m ");
        strcat(s, s_seconds);
        strcat(s, "s");
        return { s };
      } else if ( hours ) {
        strcpy(s, s_hours);
        strcat(s, "h ");
        strcat(s, s_minutes);
        strcat(s, "m ");
        strcat(s, s_seconds);
        strcat(s, "s");
        return { s };
      } else if ( minutes ) {
        strcpy(s, s_minutes);
        strcat(s, "m ");
        strcat(s, s_seconds);
        strcat(s, "s");
        return { s };
      } else {
        strcpy(s, s_seconds);
        strcat(s, "s");
        return { s };
      }
    icon: mdi:clock-start
