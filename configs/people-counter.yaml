substitutions:
  # the first two are meant to be overridden on the command line
  name: default
  ip: 172.16.1.254
  # these can be left alone unless they really need to be changed
  dname: ${name}-th
  uname: ${name}_th
  $awake_status_topic: ${uname}/binary_sensor/awake_status/state

esphome:
  name: $dname
  includes:
    - includes/MAX17048_component.h
  on_boot:
    # fix for I2C not reading after coming out of deep sleep
    - priority: 600
      then:
        - lambda: |-
           Wire.begin();
           delay(100);
    # sets status to awake
    - priority: 100
      then:
        - lambda: |-
           id(awake_status).publish_state(true)

esp32:
  board: adafruit_feather_esp32s3
  framework:
    type: arduino

# Enable logging
logger:

ota:
  password: ''

time:
  - platform: sntp
    id: the_time

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_ssid_password
  fast_connect: true
  manual_ip:
    static_ip: ${ip}
    gateway: !secret gateway
    subnet: !secret subnet
    dns1: !secret dns1
    dns2: !secret dns2

# use mqtt broker to communicate with Home Assistant
# this is recommend when using something on battery that is coming out of deep sleep
mqtt:
  broker: !secret mqtt_broker
  # don't mark sensor as available/unavailable
  birth_message:
  # sends to a topic for tracking awake/sleep
  shutdown_message:
    topic: ${awake_status_topic}
    payload: 'off'
  will_message:
    topic: ${awake_status_topic}
    payload: 'off'

# the ESP32 board used has i2c on non-standard pins
i2c:
  sda: 3
  scl: 4

# setup time of flight people counter hardware
external_components:
  - source: github://Lyr3x/Roode@master
    refresh: always
vl53l1x:
roode:

# wake up if PIR sensor active
# stay awake at least 2s and as long as motion is detected
deep_sleep:
  id: deep_sleep_1
  run_duration: 2s
  wakeup_pin: 15
  wakeup_pin_mode: KEEP_AWAKE

# setup switch to prevent sleep to do OTA updates
switch:
  - platform: template
    name: stay awake
    icon: mdi:bell-ring
    entity_category: config
    retain: true
    restore_mode: RESTORE_DEFAULT_OFF
    turn_on_action:
      - deep_sleep.prevent: deep_sleep_1
    turn_off_action:
      - deep_sleep.allow: deep_sleep_1

# setup sensors
number:
  - platform: roode
    people_counter:
      name: ${name} people

sensor:
  # this is all the time of flight stuff
  - platform: roode
    id: ${uname}
    distance_entry:
      name: ${name} entry
      filters:
        - delta: 100.0
    distance_exit:
      name: ${name} exit
      filters:
        - delta: 100.0
    min_threshold_entry:
      name: ${name} min entry
    max_threshold_entry:
      name: ${name} max entry
    min_threshold_exit:
      name: ${name} min exit
    max_threshold_exit:
      name: ${name} max exit
    roi_height_entry:
      name: ${name} height entry
    roi_height_exit:
      name: ${name} height exit
    roi_width_entry:
      name: ${name} width entry
    roi_width_exit:
      name: ${name} width exit
  # this is to measure the battery voltage and percentage remaining
  - platform: custom
    lambda: |-
      auto max17048_sensor = new MAX17048Sensor();
      App.register_component(max17048_sensor);
      return {max17048_sensor->voltage_sensor, max17048_sensor->percentage_sensor};
    sensors:
      - name: ${uname} voltage
        unit_of_measurement: V
        accuracy_decimals: 2
        state_class: measurement
      - name: ${uname} battery
        unit_of_measurement: '%'
        device_class: battery
        state_class: measurement

text_sensor:
  - platform: roode
    version:
      name: ${name} roode version
    entry_exit_event:
      name: ${name} last direction

binary_sensor:
  - platform: status
    name: awake status
    id: awake_status
    icon: mdi:led-on
    retain: true